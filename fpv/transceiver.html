<html>
  <head>
    <script src="common.js"></script>
    <!-- <script src="transceiver.js"></script> -->
    <script type="text/javascript">
      const PROTOCOL = 'transceiver'
      window.onload = async () => {
        var ws = new WebSocket(`ws://${window.location.hostname}:${window.location.port}/ws`, PROTOCOL)
        var conn
        ws.onmessage = async ({ data }) => {
          const msg = JSON.parse(data)
          if (msg.OfferOptions) {
            const { offerToReceiveVideo, offerToReceiveAudio } = msg.OfferOptions
            var stream = await navigator.mediaDevices.getUserMedia({ video: offerToReceiveVideo, audio: offerToReceiveAudio })
            conn = new RTCPeerConnection({ bundlePolicy: "max-bundle" })
            setMediaTransceiver(stream, conn, ws)
            iceCandidateHandler(conn, ws)
            dataChannelHandler(conn, PROTOCOL)
            ws.send(JSON.stringify({ active: stream.active }))
          } else {
            if (msg.type) {
              console.log('offer received:', msg.sdp)
              await conn.setRemoteDescription(msg)
              setReceiverAnswerCodec(conn)
              const answer = await conn.createAnswer()
              console.log('answer:', answer.sdp)
              await conn.setLocalDescription(answer)
              ws.send(JSON.stringify(answer))
            } else {
              console.log('ice:', msg)
              await conn.addIceCandidate(msg)
            }
          }
        }
      }
    </script>
  </head>

  <body></body>
</html>
