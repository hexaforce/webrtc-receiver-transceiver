<html>

<head>
  <script src="common.js"></script>
  <!-- <script src="transceiver.js"></script> -->
  <script type="text/javascript">
    const PROTOCOL = 'transceiver'
    window.onload = async () => {
      var ws = new WebSocket(`ws://${window.location.hostname}:${window.location.port}/ws`, PROTOCOL)
      var conn

      ws.onopen = async () => {
        conn = new RTCPeerConnection()
        iceCandidateHandler(conn, ws)
        dataChannelHandler(conn, PROTOCOL)
        await setMediaTransceiver(conn, ws)

        const offer = await conn.createOffer()
        console.log('offer:', offer.sdp)
        await conn.setLocalDescription(offer)
        ws.send(JSON.stringify(offer))
      }

      ws.onmessage = async ({ data }) => {
        const msg = JSON.parse(data)
        if (msg.type) {
          console.log('answer:', msg.sdp)
          await conn.setRemoteDescription(msg)
        } else {
          await conn.addIceCandidate(msg)
        }
      }
    }
  </script>
</head>

<body></body>

</html>