<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="../../../css/main.css" />
  <link rel="stylesheet" href="css/main.css" />
</head>

<body>
  <div id="container">
    <span id="banner"></span>
    <h2>Sender and receiver</h2>
    <div id="videos">
      <p>Sender and receiver</p>
      <video id="video1" playsinline autoplay muted></video>
      <video id="video2" playsinline autoplay></video>
    </div>
    <p>Crypto key: <input type="text" id="crypto-key" /></p>
    <p>Encrypt first bytes: <input type="checkbox" id="crypto-offset" /></p>
    <h2>Middlebox</h2>
    <div id="monitor">
      <video id="video-monitor" playsinline autoplay muted></video>
      <p>Switch audio to middlebox: <input type="checkbox" id="mute-middlebox" /></p>
    </div>
    <div id="buttons">
      <button id="startButton">Start</button>
      <button id="callButton" disabled>Call</button>
      <button id="hangupButton" disabled>Hang Up</button>
    </div>
    <div id="status"></div>
  </div>
  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
  <script>

    function VideoPipe(stream, forceSend, forceReceive, handler) {
      this.pc1 = new RTCPeerConnection({ encodedInsertableStreams: forceSend })
      this.pc2 = new RTCPeerConnection({ encodedInsertableStreams: forceReceive })
      this.pc2.ontrack = handler
      stream.getTracks().forEach((track) => this.pc1.addTrack(track, stream))
    }

    VideoPipe.prototype.negotiate = async function () {
      this.pc1.onicecandidate = (e) => this.pc2.addIceCandidate(e.candidate)
      this.pc2.onicecandidate = (e) => this.pc1.addIceCandidate(e.candidate)

      const offer = await this.pc1.createOffer()
      await this.pc2.setRemoteDescription(offer)
      await this.pc1.setLocalDescription(offer)

      const answer = await this.pc2.createAnswer()
      await this.pc1.setRemoteDescription(answer)
      await this.pc2.setLocalDescription(answer)
    }

    VideoPipe.prototype.close = function () {
      this.pc1.close()
      this.pc2.close()
    }
  </script>
  <script src="js/main.js" async></script>
</body>

</html>